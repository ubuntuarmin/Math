gemini<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Katy Math</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

<!-- LOGIN -->
<div id="authContainer" class="flex flex-col items-center justify-center min-h-screen gap-4">
  <h1 class="text-2xl font-bold">Welcome</h1>
  <input id="emailInput" type="email" placeholder="Email" class="p-2 rounded text-black w-64">
  <input id="passwordInput" type="password" placeholder="Password" class="p-2 rounded text-black w-64">
  <button onclick="signUp()" class="bg-green-600 px-4 py-2 rounded w-64">Sign Up</button>
  <button onclick="logIn()" class="bg-blue-600 px-4 py-2 rounded w-64">Log In</button>
</div>

<!-- APP -->
<div id="appContainer" class="hidden">
  <header class="fixed top-0 left-0 right-0 bg-gray-800 z-40 shadow">
    <div class="max-w-5xl mx-auto flex justify-between items-center p-4">
      <h1 class="text-lg font-semibold">Dashboard</h1>
      <div onclick="openRewardModal()" class="cursor-pointer relative">
        ðŸª™ <span id="creditCount">0</span>
      </div>
      <button onclick="logOut()" class="bg-red-600 px-3 py-1 rounded">Logout</button>
    </div>
  </header>
  <div class="pt-20 max-w-5xl mx-auto px-4">
    <div id="app"></div>
  </div>

  <!-- REWARD MODAL -->
  <div id="rewardModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded w-full max-w-md">
      <h2 class="text-xl mb-4">Reward Timeline</h2>
      <div class="w-full bg-gray-700 h-3 rounded mb-4">
        <div id="timelineFill" class="bg-green-500 h-3 rounded transition-all duration-700"></div>
      </div>
      <button id="redeemBtn" onclick="redeemWelcome()" class="w-full bg-blue-600 py-2 rounded disabled:opacity-40">
        Redeem Welcome Reward (+50)
      </button>
      <button onclick="closeRewardModal()" class="mt-3 text-gray-400 w-full">Close</button>
    </div>
  </div>

  <!-- IFRAME MODAL -->
  <div id="iframeModal" class="hidden fixed inset-0 bg-black z-50">
    <button onclick="closeIframe()" class="absolute top-4 right-4 bg-red-600 px-4 py-2 rounded">Close</button>
    <iframe id="contentIframe" class="w-full h-full"></iframe>
    <div id="afkWarning" class="hidden absolute inset-0 flex items-center justify-center bg-black bg-opacity-80">
      <div class="bg-gray-800 p-6 rounded">
        <p class="mb-4">Still there?</p>
        <button onclick="dismissAFK()" class="bg-blue-600 px-4 py-2 rounded">I'm here</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA32Jc5l0jcWW9iAT3q1gUEUsthN6QkY1k",
  authDomain: "math-katy.firebaseapp.com",
  projectId: "math-katy",
  storageBucket: "math-katy.appspot.com",
  messagingSenderId: "1042280286644",
  appId: "1:1042280286644:web:fbfa68fb1c94dd4d4dcae1",
  measurementId: "G-ZHDTNX60VG"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const authContainer = document.getElementById("authContainer");
const appContainer = document.getElementById("appContainer");
const creditCount = document.getElementById("creditCount");

let currentUserData = null;
let sessionInterval = null;
let afk = false;
let afkTimer;

// AUTH FUNCTIONS
function generateReferralCode() { return Math.random().toString(36).substring(2,8).toUpperCase(); }

async function signUp() {
  console.log("Sign Up clicked");
  const email = document.getElementById("emailInput").value;
  const password = document.getElementById("passwordInput").value;
  if(!email || !password){ alert("Enter email and password"); return; }
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    console.log("User created:", user.uid);

    await setDoc(doc(db, "users", user.uid), {
      credits: 0,
      welcomeClaimed: false,
      referralCode: generateReferralCode()
    });

    // Switch to app view
    authContainer.classList.add("hidden");
    appContainer.classList.remove("hidden");
    await loadUserData(user.uid);
    renderDashboard();

  } catch(err){ 
    console.error("SignUp error:", err);
    alert(err.message); 
  }
}

async function logIn() {
  console.log("Log In clicked");
  const email = document.getElementById("emailInput").value;
  const password = document.getElementById("passwordInput").value;
  if(!email || !password){ alert("Enter email and password"); return; }
  try { 
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    console.log("Logged in:", user.uid);

    authContainer.classList.add("hidden");
    appContainer.classList.remove("hidden");
    await loadUserData(user.uid);
    renderDashboard();

  } catch(err){ 
    console.error("Login error:", err);
    alert(err.message); 
  }
}

function logOut() { 
  signOut(auth); 
}

// ON AUTH STATE
onAuthStateChanged(auth, async(user) => {
  if(user){
    authContainer.classList.add("hidden");
    appContainer.classList.remove("hidden");
    await loadUserData(user.uid);
    renderDashboard();
  }else{
    authContainer.classList.remove("hidden");
    appContainer.classList.add("hidden");
  }
});

// USER DATA
async function loadUserData(uid){
  const snap = await getDoc(doc(db,"users",uid));
  if(!snap.exists()) return;
  currentUserData = snap.data();
  updateCredits();
}

function updateCredits(){
  creditCount.textContent = currentUserData?.credits ?? 0;
}

// REWARDS
async function redeemWelcome(){
  if(currentUserData?.welcomeClaimed) return;
  const ref = doc(db,"users",auth.currentUser.uid);
  currentUserData.credits +=50;
  currentUserData.welcomeClaimed=true;
  await updateDoc(ref,{credits:currentUserData.credits,welcomeClaimed:true});
  updateCredits();
  document.getElementById("timelineFill").style.width = Math.min((currentUserData.credits/600)*100,100)+"%";
}

// DASHBOARD
const appEl=document.getElementById("app");
function renderDashboard(){
  appEl.innerHTML=`
  <div class="mb-6 flex gap-4">
    <button onclick="renderDashboard()" class="bg-gray-700 px-4 py-2 rounded">Dashboard</button>
  </div>
  <h2 class="text-xl mb-4">General Links</h2>
  <div class="grid grid-cols-3 gap-4">
    ${[1,2,3].map(i=>`<div onclick="openIframe(${i})" class="bg-gray-800 p-4 rounded cursor-pointer hover:bg-gray-700">Link ${i}</div>`).join("")}
  </div>`;
}

// IFRAME & TIME TRACKING
const iframeModal=document.getElementById("iframeModal");
const contentIframe=document.getElementById("contentIframe");
async function openIframe(linkId){
  iframeModal.classList.remove("hidden");
  contentIframe.src="https://en.wikipedia.org/wiki/Main_Page";

  const uid=auth.currentUser.uid;
  const sessionRef=doc(db,"sessions",`${uid}_${linkId}`);
  const snap=await getDoc(sessionRef);
  if(!snap.exists()){
    await setDoc(sessionRef,{
      uid,linkId,
      startTime:serverTimestamp(),
      lastTick:serverTimestamp(),
      minutesEarnedToday:0,
      active:true
    });
  }

  sessionInterval=setInterval(()=>tickSession(sessionRef),60_000);
  resetAFK();
}

async function tickSession(sessionRef){
  if(afk) return;
  const snap=await getDoc(sessionRef);
  if(!snap.exists()) return;
  let data=snap.data();
  if(data.minutesEarnedToday>=30){ closeIframe(); alert("Daily limit reached"); return; }
  if((data.minutesEarnedToday+1)%10===0){
    currentUserData.credits+=1;
    updateCredits();
    await updateDoc(doc(db,"users",auth.currentUser.uid),{credits:currentUserData.credits});
  }
  await updateDoc(sessionRef,{
    minutesEarnedToday: increment(1),
    lastTick: serverTimestamp()
  });
}

function closeIframe(){ clearInterval(sessionInterval); iframeModal.classList.add("hidden"); }

// AFK
function resetAFK(){ afk=false; clearTimeout(afkTimer); afkTimer=setTimeout(()=>{afk=true; alert("AFK detected"); },5*60*1000); }
document.addEventListener("mousemove",resetAFK);
document.addEventListener("keydown",resetAFK);

</script>
</body>
</html>
