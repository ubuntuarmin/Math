<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Katy Math</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Spinning token */
.token-spin { animation: spin 3s linear infinite; }
@keyframes spin { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }

/* Loader */
.loader { width:64px; height:64px; border-radius:50%; border:6px solid #1f2937; border-top:6px solid #22c55e; animation: spin 1s linear infinite; }

/* Pulse effect */
.pulse { animation: pulse 1.5s infinite; }
@keyframes pulse { 0%{opacity:.3}50%{opacity:1}100%{opacity:.3} }

/* Login modal */
#loginModal { position:fixed; inset:0; z-index:50; }
#loginModal:not(.hidden) { display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); }
#loginModal .panel { width:320px; background:#0f172a; padding:18px; border-radius:8px; box-shadow:0 6px 30px rgba(0,0,0,0.6); }
#loginModal input { width:100%; margin-top:8px; padding:8px; background:#0b1220; border:1px solid #1f2937; color:#e5e7eb; border-radius:6px; }
#loginModal button { margin-top:12px; width:100%; }

/* Fullscreen welcome overlay */
#welcomeOverlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index:60; pointer-events:none; }
#welcomeOverlay.show { display:flex; pointer-events:auto; }
.welcome-full {
  width:100%; height:100%; display:flex; align-items:center; justify-content:center;
  background: linear-gradient(180deg, rgba(2,6,23,0.95), rgba(2,6,23,0.85));
  backdrop-filter: blur(6px);
}
.welcome-card {
  background: linear-gradient(135deg,#0ea5a4,#7c3aed);
  color:white; padding:30px 36px; border-radius:18px; box-shadow:0 20px 60px rgba(2,6,23,0.7);
  transform: translateY(20px) scale(.96); opacity: 0; display:flex; gap:18px; align-items:center;
  max-width:920px; width:90%;
}
.welcome-logo { width:88px; height:88px; border-radius:16px; background:rgba(255,255,255,.12); display:flex; align-items:center; justify-content:center; font-size:36px; transform-origin:center; }
@keyframes welcome-pop {
  0% { transform: translateY(30px) scale(.94); opacity:0; }
  60% { transform: translateY(-8px) scale(1.03); opacity:1; }
  100% { transform: translateY(0) scale(1); opacity:1; }
}
@keyframes logo-bounce {
  0% { transform: translateY(0) rotate(-6deg) }
  50% { transform: translateY(-6px) rotate(8deg) }
  100% { transform: translateY(0) rotate(0deg) }
}
.welcome-card.animate { animation: welcome-pop 700ms cubic-bezier(.2,.9,.3,1) forwards; }
.welcome-logo.animate { animation: logo-bounce 900ms cubic-bezier(.2,.9,.3,1) forwards; }

/* Onboarding modal */
#onboardModal { position:fixed; inset:0; z-index:70; }
#onboardModal:not(.hidden) { display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); }
#onboardModal .panel { width:420px; background:#071024; padding:20px; border-radius:12px; color:#e6eef8; }

/* daily streak interactive styles */
.day-card { transition: transform .14s ease, box-shadow .14s ease; cursor: pointer; }
.day-card:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 12px 30px rgba(2,6,23,0.6); }
.redeem-btn { background:#065f46; color:white; padding:6px 8px; border-radius:8px; font-size:12px; border:none; }
.redeem-btn[disabled] { background:#334155; opacity:.7; cursor:not-allowed; }
.floating-credit {
  position: absolute; pointer-events:none; transform: translateY(0); opacity:1;
  transition: transform 700ms cubic-bezier(.2,.9,.3,1), opacity 700ms;
  color:#34d399; font-weight:700;
}
</style>
<script>
  (function() {
    const urlParams = new URLSearchParams(window.location.search);
    const ref = urlParams.get('ref');
    if (ref) {
      sessionStorage.setItem('pendingReferral', ref);
      window.history.replaceState({}, document.title, window.location.pathname);
      console.log("Referral system: Code captured and stored.");
    }
  })();
</script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

<header id="header" class="hidden fixed top-0 w-full bg-gray-800 z-40 shadow">
  <div class="max-w-6xl mx-auto flex justify-between items-center p-4">
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2">
        <div class="token-spin text-yellow-400 text-xl">ðŸª™</div>
        <span id="creditCount">0</span>
      </div>
      <button id="tierBtn" class="text-sm text-blue-400 underline">Tier: <span id="tierLabel">Basic</span></button>
    </div>
    <div class="flex gap-4">
      <button onclick="navigate('dashboard')">Dashboard</button>
      <button onclick="navigate('tokens')">Tokens</button>
      <button onclick="navigate('leaderboard')">Leaderboard</button>
      <button onclick="navigate('account')">Account</button>
      <a href="tutoring.html" class="bg-blue-600/20 hover:bg-blue-600 px-3 py-1 rounded transition border border-blue-500/50 flex items-center justify-center">
        Chat
    </a>
      <button id="logoutBtn" class="bg-red-600 px-3 py-1 rounded font-bold">Logout</button>
    </div>
  </div>
</header>

<main id="appContainer" class="pt-24 max-w-6xl mx-auto p-4">
  
  <section id="dashboardPage">
    <div id="siteInfoBox" class="mb-8 bg-blue-900/20 border border-blue-500/30 rounded-xl p-6 relative overflow-hidden">
      <button onclick="document.getElementById('siteInfoBox').remove()" class="absolute top-3 right-4 text-gray-500 hover:text-white transition text-xl">&times;</button>
      
      <div class="flex items-start gap-4">
        <div class="text-3xl">ðŸš€</div>
        <div>
          <h3 class="text-lg font-bold text-blue-400 mb-2">Beta Version 1.0</h3>
          <div class="text-sm text-gray-300 space-y-3 leading-relaxed">
            <p>
              This is v1 betaâ€”there are lots of bugs, but we are working to fix them! 
              <span class="text-yellow-400 font-bold underline">PRO TIP:</span> For now, the best link to use is the **3rd link**.
            </p>
            <p>
              Share the site with your **Referral URL** (found in Account) to gain credits! Prizes are coming to the leaderboard soon.
            </p>
            <p class="text-xs text-gray-400 italic">
              Note: We restrict time and users per link to prevent sites from getting blocked. If you refer enough people, you will gain more play time!
            </p>
          </div>
        </div>
      </div>
    </div>

    <h2 class="text-xl mb-4 font-bold text-gray-400 uppercase tracking-widest text-sm">General Links</h2>
    <div id="links" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
  </section>

  <section id="tokensPage" class="hidden space-y-6">
    <div class="bg-gray-800 p-6 rounded">
      <div class="flex items-center gap-4">
        <div class="token-spin text-4xl">ðŸª™</div>
        <div>
          <div class="font-semibold">Next Reward</div>
          <div id="nextReward" class="text-green-400 text-sm"></div>
        </div>
      </div>
    </div>
    <div class="bg-gray-800 p-6 rounded">
      <h3 class="font-semibold mb-3">Daily Streak</h3>
      <div id="dailyTracker" class="grid grid-cols-10 gap-3"></div>
    </div>
  </section>

  <section id="leaderboardPage" class="hidden">
    <h2 class="text-xl mb-4">Weekly Leaderboard</h2>
    <div id="leaderboard" class="bg-gray-800 p-4 rounded space-y-2"></div>
  </section>

  <section id="accountPage" class="hidden">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
      <div id="accountInfo" class="space-y-1"></div>

      <div id="editProfileForm" class="hidden border-t border-gray-700 pt-4 mt-4 space-y-3">
        <h4 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Edit Profile</h4>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-gray-500">First Name</label>
            <input id="editFirst" type="text" class="w-full bg-gray-900 p-2 rounded border border-gray-700 focus:border-blue-500 outline-none">
          </div>
          <div>
            <label class="text-xs text-gray-500">Last Name</label>
            <input id="editLast" type="text" class="w-full bg-gray-900 p-2 rounded border border-gray-700 focus:border-blue-500 outline-none">
          </div>
        </div>
        <div>
          <label class="text-xs text-gray-500">Grade</label>
          <select id="editGrade" class="w-full bg-gray-900 p-2 rounded border border-gray-700 focus:border-blue-500 outline-none">
            <option value="">Select grade</option>
            <option>Kindergarten</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            <option>11</option><option>12</option>
          </select>
        </div>
        <div class="flex gap-2 pt-2">
          <button id="saveProfileBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm font-medium transition">Save Changes</button>
          <button id="cancelEditBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm font-medium transition">Cancel</button>
        </div>
      </div>

      <button id="showEditBtn" class="text-sm text-blue-400 hover:text-blue-300 underline transition">Edit Profile</button>
      
      <div class="pt-4 border-t border-gray-700">
        <div class="text-sm text-gray-400">Total Minutes on Site: <span id="totalMinutes" class="text-white">0</span></div>
        <div id="referralArea" class="mt-3"></div>
      </div>

      <div class="pt-10 mt-10 border-t border-red-900/30">
        <h4 class="text-xs font-bold text-red-500 uppercase tracking-widest mb-2">Danger Zone</h4>
        <p class="text-[10px] text-gray-400 mb-4">Deleting your account removes all credits, leaderboard history, and data permanently.</p>
        <button id="deleteAccountBtn" class="bg-red-900/20 hover:bg-red-600 text-red-500 hover:text-white border border-red-900 px-4 py-2 rounded-lg text-xs font-bold transition">
            Delete My Account
        </button>
      </div>
    </div>
  </section>
</main>

<div id="loginModal" class="hidden" aria-hidden="true">
  <div class="panel">
    <h3 class="text-lg font-semibold">Sign in to Katy Math</h3>
    <div id="loginError" class="text-red-400 text-sm mt-2"></div>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <input id="referralCodeInput" type="text" placeholder="Referral code (optional)" />
    <div class="flex gap-2">
      <button id="signInBtn" class="bg-blue-600 px-3 py-2 rounded">Sign In</button>
      <button id="signUpBtn" class="bg-green-600 px-3 py-2 rounded">Create Account</button>
    </div>
  </div>
</div>

<div id="onboardModal" class="hidden" aria-hidden="true">
  <div class="panel">
    <h3 class="text-lg font-semibold">Welcome! Tell us about you</h3>
    <div id="onboardError" class="text-red-400 text-sm mt-2"></div>
    <input id="onboardFirst" type="text" placeholder="First name" />
    <input id="onboardLast" type="text" placeholder="Last name" />
    <select id="onboardGrade" class="mt-2 w-full bg-gray-900 text-white p-2 rounded">
      <option value="">Select grade</option>
      <option>Kindergarten</option>
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
      <option>11</option><option>12</option>
    </select>
    <div class="flex gap-2 mt-3">
      <button id="onboardSave" class="bg-blue-600 px-3 py-2 rounded">Save & Continue</button>
    </div>
  </div>
</div>

<div id="welcomeOverlay" aria-hidden="true">
  <div class="welcome-full">
    <div class="welcome-card" id="welcomeCard">
      <div class="welcome-logo" id="welcomeLogo">âœ¨</div>
      <div>
        <div id="welcomeTitle" class="text-3xl font-bold">Welcome</div>
        <div id="welcomeSub" class="text-lg opacity-90 mt-1">Ready to earn some credits?</div>
      </div>
    </div>
  </div>
</div>

<script type="module" src="./js/firebase.js"></script>
<script type="module" src="./js/utils.js?v=9"></script>
<script type="module" src="./js/login.js?v=8"></script>
<script type="module" src="./js/onboarding.js?v=1"></script>
<script type="module" src="./js/auth.js?v=8"></script>
<script type="module" src="./js/dashboard.js?v=6"></script>
<script type="module" src="./js/tokens.js?v=8"></script>
<script type="module" src="./js/leaderboard.js?v=6"></script>
<script type="module" src="./js/account.js?v=8"></script>
<script type="module" src="./js/welcome.js?v=2"></script>
<script type="module" src="./js/blockExtensions.js"></script>

</body>
</html>
