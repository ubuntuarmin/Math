<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Katy Math</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

<!-- AUTH -->
<div id="authContainer" class="flex flex-col items-center justify-center min-h-screen gap-4">
  <h1 class="text-2xl font-bold">Welcome</h1>
  <input id="emailInput" type="email" placeholder="Email" class="p-2 rounded text-black w-64">
  <input id="passwordInput" type="password" placeholder="Password" class="p-2 rounded text-black w-64">
  <button onclick="signUp()" class="bg-green-600 px-4 py-2 rounded w-64">Sign Up</button>
  <button onclick="logIn()" class="bg-blue-600 px-4 py-2 rounded w-64">Log In</button>

  <button onclick="showAdminLogin()" class="text-gray-400 text-sm mt-4">Admin Login</button>
</div>

<!-- ADMIN -->
<div id="adminPanel" class="hidden p-6">
  <h2 class="text-xl mb-4">Admin Panel</h2>
  <div id="adminUsers" class="space-y-2"></div>
  <button onclick="exitAdmin()" class="mt-6 bg-red-600 px-4 py-2 rounded">Exit</button>
</div>

<!-- APP -->
<div id="appContainer" class="hidden">
<header class="fixed top-0 w-full bg-gray-800 z-40 p-4 flex justify-between">
  <span>Credits: <span id="creditCount">0</span> | Tier: <span id="tierLabel">Basic</span></span>
  <button onclick="logOut()" class="bg-red-600 px-3 py-1 rounded">Logout</button>
</header>

<div class="pt-20 p-6" id="app"></div>
</div>

<!-- IFRAME -->
<div id="iframeModal" class="hidden fixed inset-0 bg-black z-50">
  <div class="absolute top-2 left-2 text-sm">Time left: <span id="iframeTimer">45:00</span></div>
  <button onclick="closeIframe()" class="absolute top-2 right-2 bg-red-600 px-3 py-1 rounded">Close</button>
  <iframe id="contentIframe" class="w-full h-full"></iframe>

  <div id="siteCheck" class="hidden absolute inset-0 flex items-center justify-center bg-black bg-opacity-80">
    <div class="bg-gray-800 p-6 rounded text-center">
      <p class="mb-4">Is this site working?</p>
      <button onclick="reportSite(true)" class="bg-green-600 px-4 py-2 rounded mr-2">Yes</button>
      <button onclick="reportSite(false)" class="bg-red-600 px-4 py-2 rounded">No</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, collection, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA32Jc5l0jcWW9iAT3q1gUEUsthN6QkY1k",
  authDomain: "math-katy.firebaseapp.com",
  projectId: "math-katy",
  storageBucket: "math-katy.appspot.com",
  messagingSenderId: "1042280286644",
  appId: "1:1042280286644:web:fbfa68fb1c94dd4d4dcae1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData = null;
let iframeInterval, afkTimer, iframeSeconds = 0, earnedToday = 0;
let currentLink = null;

// ---------- AUTH ----------
async function signUp(){
  const email = emailInput.value;
  const password = passwordInput.value;
  const cred = await createUserWithEmailAndPassword(auth,email,password);
  await setDoc(doc(db,"users",cred.user.uid),{
    credits:0,
    totalEarned:0,
    welcome:false,
    lastLogin:null,
    banned:false
  });
}

async function logIn(){
  await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
}

function logOut(){ signOut(auth); }

// ---------- ADMIN ----------
function showAdminLogin(){
  const u = prompt("Admin user");
  const p = prompt("Admin pass");
  if(u==="Armin" && p==="2351"){
    authContainer.classList.add("hidden");
    adminPanel.classList.remove("hidden");
    loadAdmin();
  }
}

async function loadAdmin(){
  const snap = await getDocs(collection(db,"users"));
  adminUsers.innerHTML="";
  snap.forEach(d=>{
    const u=d.data();
    adminUsers.innerHTML+=`
    <div class="bg-gray-800 p-2 rounded flex justify-between">
      <span>${d.id} | ${u.credits}</span>
      <button onclick="modCredits('${d.id}',10)">+10</button>
      <button onclick="modCredits('${d.id}',-10)">-10</button>
      <button onclick="banUser('${d.id}')">Ban</button>
    </div>`;
  });
}

async function modCredits(uid,val){
  await updateDoc(doc(db,"users",uid),{credits:increment(val)});
  loadAdmin();
}

async function banUser(uid){
  await updateDoc(doc(db,"users",uid),{banned:true});
  loadAdmin();
}

function exitAdmin(){
  adminPanel.classList.add("hidden");
  authContainer.classList.remove("hidden");
}

// ---------- USER ----------
onAuthStateChanged(auth, async(user)=>{
  if(!user) return;
  const ref=doc(db,"users",user.uid);
  const snap=await getDoc(ref);
  userData=snap.data();

  if(userData.banned){ alert("Account banned"); logOut(); return; }

  const today=new Date().toDateString();
  if(userData.lastLogin!==today){
    await updateDoc(ref,{
      credits:increment(10),
      totalEarned:increment(10),
      lastLogin:today
    });
  }

  if(!userData.welcome){
    await updateDoc(ref,{credits:increment(50),totalEarned:increment(50),welcome:true});
  }

  authContainer.classList.add("hidden");
  appContainer.classList.remove("hidden");
  updateUI();
});

function tier(){
  const t=userData.totalEarned;
  if(t>=1000) return "VIP";
  if(t>=800) return "Gold";
  if(t>=400) return "Silver";
  return "Basic";
}

function updateUI(){
  creditCount.textContent=userData.credits;
  tierLabel.textContent=tier();
  renderLinks();
}

// ---------- LINKS ----------
function renderLinks(){
  app.innerHTML=`<div class="grid grid-cols-3 gap-4">
  <div onclick="openIframe('basic')" class="bg-gray-800 p-4 rounded">Basic</div>
  ${userData.credits>=100?`<div onclick="openIframe('loyal')" class="bg-gray-800 p-4 rounded">Loyal</div>`:""}
  ${userData.credits>=200?`<div onclick="openIframe('vip')" class="bg-gray-800 p-4 rounded">VIP</div>`:""}
  </div>`;
}

// ---------- IFRAME ----------
function openIframe(link){
  currentLink=link;
  iframeSeconds=0;
  earnedToday=0;
  iframeModal.classList.remove("hidden");
  contentIframe.src="https://en.wikipedia.org/wiki/Main_Page";
  setTimeout(()=>siteCheck.classList.remove("hidden"),5000);

  iframeInterval=setInterval(tick,1000);
  resetAFK();
}

function tick(){
  iframeSeconds++;
  iframeTimer.textContent=`${Math.max(0,45*60-iframeSeconds)}`;
  if(iframeSeconds%600===0){
    userData.credits++;
    userData.totalEarned++;
    updateDoc(doc(db,"users",auth.currentUser.uid),{
      credits:userData.credits,
      totalEarned:userData.totalEarned
    });
    updateUI();
  }
  if(iframeSeconds>=2700) closeIframe();
}

function closeIframe(){
  clearInterval(iframeInterval);
  iframeModal.classList.add("hidden");
  contentIframe.src="";
}

// ---------- AFK ----------
function resetAFK(){
  clearTimeout(afkTimer);
  afkTimer=setTimeout(()=>{alert("AFK kicked"); closeIframe();},300000);
}

document.addEventListener("mousemove",resetAFK);
document.addEventListener("keydown",resetAFK);

// ---------- SITE REPORT ----------
async function reportSite(ok){
  siteCheck.classList.add("hidden");
  await setDoc(doc(db,"siteReports",Date.now()+""),{ok});
}

// expose
Object.assign(window,{
  signUp,logIn,logOut,openIframe,closeIframe,
  showAdminLogin,exitAdmin
});
</script>
</body>
</html>
