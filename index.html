<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Katy Math</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen">

<!-- AUTH -->
<div id="authContainer" class="flex flex-col items-center justify-center min-h-screen gap-4">
  <h1 class="text-2xl font-bold">Welcome to Katy Math</h1>
  <input id="emailInput" type="email" placeholder="Email" class="p-2 rounded text-black w-64">
  <input id="passwordInput" type="password" placeholder="Password" class="p-2 rounded text-black w-64">
  <button onclick="signUp()" class="bg-green-600 px-4 py-2 rounded w-64">Sign Up</button>
  <button onclick="logIn()" class="bg-blue-600 px-4 py-2 rounded w-64">Log In</button>
  <button onclick="adminLogin()" class="text-sm text-gray-400 mt-4">Admin Login</button>
</div>

<!-- HEADER -->
<header id="header" class="hidden fixed top-0 w-full bg-gray-800 z-40 shadow">
  <div class="max-w-6xl mx-auto flex justify-between items-center p-4">
    <div>
      <div class="font-semibold">
        Credits: <span id="creditCount">0</span> · Tier: <span id="tierLabel">Basic</span>
      </div>
      <div class="text-xs text-gray-400">
        Next reward in <span id="nextReward">10</span> min
      </div>
    </div>
    <button onclick="logOut()" class="bg-red-600 px-3 py-1 rounded">Logout</button>
  </div>
</header>

<!-- APP -->
<div id="appContainer" class="hidden pt-24 max-w-6xl mx-auto p-4">
  <div id="earnInfo" class="bg-gray-800 p-4 rounded mb-6">
    <h2 class="font-semibold mb-2">How to earn credits</h2>
    <ul class="text-sm text-gray-300 space-y-1">
      <li>• +50 welcome reward (one time)</li>
      <li>• +10 daily login</li>
      <li>• +1 credit every 10 active minutes in a link</li>
      <li>• AFK or tab hidden time does not count</li>
    </ul>
  </div>

  <div id="links" class="grid grid-cols-3 gap-4"></div>
</div>

<!-- ONBOARDING -->
<div id="onboarding" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center">
  <div class="bg-gray-800 p-6 rounded w-full max-w-sm">
    <h2 class="text-xl mb-4">Tell us about you</h2>
    <input id="firstName" placeholder="First name" class="p-2 rounded text-black w-full mb-2">
    <input id="lastName" placeholder="Last name" class="p-2 rounded text-black w-full mb-2">
    <input id="grade" placeholder="Grade" class="p-2 rounded text-black w-full mb-4">
    <button onclick="saveOnboarding()" class="bg-blue-600 w-full py-2 rounded">Continue</button>
  </div>
</div>

<!-- IFRAME -->
<div id="iframeModal" class="hidden fixed inset-0 bg-black z-50">
  <div class="absolute top-3 left-3 text-sm">Time left: <span id="iframeTimer">45:00</span></div>
  <button onclick="closeIframe()" class="absolute top-3 right-3 bg-red-600 px-3 py-1 rounded">Close</button>
  <iframe id="contentIframe" class="w-full h-full"></iframe>
</div>

<!-- ADMIN -->
<div id="adminPanel" class="hidden p-6">
  <h2 class="text-xl mb-4">Admin Panel</h2>
  <div id="adminUsers" class="space-y-2"></div>
  <button onclick="exitAdmin()" class="mt-6 bg-red-600 px-4 py-2 rounded">Exit</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, getDocs, collection, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA32Jc5l0jcWW9iAT3q1gUEUsthN6QkY1k",
  authDomain: "math-katy.firebaseapp.com",
  projectId: "math-katy",
  storageBucket: "math-katy.appspot.com",
  messagingSenderId: "1042280286644",
  appId: "1:1042280286644:web:fbfa68fb1c94dd4d4dcae1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData = null;
let iframeInterval = null;
let iframeSeconds = 0;
let afkTimer = null;
let tabActive = true;

// ---------- AUTH ----------
async function signUp(){
  const cred = await createUserWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
  await setDoc(doc(db,"users",cred.user.uid),{
    credits:0,
    totalEarned:0,
    welcome:false,
    lastLogin:null,
    onboarded:false,
    banned:false
  });
}

async function logIn(){
  await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
}

function logOut(){
  signOut(auth);
}

// ---------- STATE ----------
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    authContainer.classList.remove("hidden");
    appContainer.classList.add("hidden");
    header.classList.add("hidden");
    return;
  }

  const ref = doc(db,"users",user.uid);
  const snap = await getDoc(ref);
  userData = snap.data();

  if(userData.banned){
    alert("Account banned");
    logOut();
    return;
  }

  const today = new Date().toDateString();
  if(userData.lastLogin !== today){
    await updateDoc(ref,{
      credits: increment(10),
      totalEarned: increment(10),
      lastLogin: today
    });
  }

  if(!userData.welcome){
    await updateDoc(ref,{
      credits: increment(50),
      totalEarned: increment(50),
      welcome:true
    });
  }

  authContainer.classList.add("hidden");
  appContainer.classList.remove("hidden");
  header.classList.remove("hidden");

  if(!userData.onboarded){
    onboarding.classList.remove("hidden");
  }

  renderUI();
});

// ---------- UI ----------
function tier(){
  const t=userData.totalEarned;
  if(t>=1000) return "VIP";
  if(t>=800) return "Gold";
  if(t>=400) return "Silver";
  return "Basic";
}

function renderUI(){
  creditCount.textContent = userData.credits;
  tierLabel.textContent = tier();
  renderLinks();
}

function renderLinks(){
  links.innerHTML = `
    <div onclick="openIframe()" class="bg-gray-800 p-4 rounded cursor-pointer text-center">
      Basic Link
    </div>
  `;
}

// ---------- ONBOARDING ----------
async function saveOnboarding(){
  await updateDoc(doc(db,"users",auth.currentUser.uid),{
    firstName:firstName.value,
    lastName:lastName.value,
    grade:grade.value,
    onboarded:true
  });
  onboarding.classList.add("hidden");
}

// ---------- IFRAME ----------
function openIframe(){
  iframeSeconds = 0;
  iframeModal.classList.remove("hidden");
  contentIframe.src = "https://en.wikipedia.org/wiki/Main_Page";
  iframeInterval = setInterval(tickIframe,1000);
  resetAFK();
}

function tickIframe(){
  if(!tabActive) return;
  iframeSeconds++;
  const remaining = Math.max(0,2700-iframeSeconds);
  iframeTimer.textContent = `${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,"0")}`;

  if(iframeSeconds % 600 === 0){
    updateDoc(doc(db,"users",auth.currentUser.uid),{
      credits: increment(1),
      totalEarned: increment(1)
    });
    userData.credits++;
    userData.totalEarned++;
    renderUI();
  }

  if(iframeSeconds >= 2700) closeIframe();
}

function closeIframe(){
  clearInterval(iframeInterval);
  iframeModal.classList.add("hidden");
  contentIframe.src="";
}

// ---------- AFK + TAB ----------
function resetAFK(){
  clearTimeout(afkTimer);
  afkTimer = setTimeout(()=>{
    alert("AFK detected. Session ended.");
    closeIframe();
  },300000);
}

document.addEventListener("mousemove",resetAFK);
document.addEventListener("keydown",resetAFK);

document.addEventListener("visibilitychange",()=>{
  tabActive = !document.hidden;
});

// ---------- ADMIN ----------
function adminLogin(){
  const u=prompt("Admin user");
  const p=prompt("Admin pass");
  if(u==="Armin" && p==="2351"){
    authContainer.classList.add("hidden");
    adminPanel.classList.remove("hidden");
    loadAdmin();
  }
}

async function loadAdmin(){
  adminUsers.innerHTML="";
  const snap = await getDocs(collection(db,"users"));
  snap.forEach(d=>{
    adminUsers.innerHTML+=`
      <div class="bg-gray-800 p-2 rounded flex justify-between">
        <span>${d.id}</span>
        <button onclick="confirmCredit('${d.id}',10)">+10</button>
        <button onclick="confirmCredit('${d.id}',-10)">-10</button>
      </div>
    `;
  });
}

async function confirmCredit(uid,val){
  if(confirm("Are you sure?")){
    await updateDoc(doc(db,"users",uid),{credits:increment(val)});
    loadAdmin();
  }
}

function exitAdmin(){
  adminPanel.classList.add("hidden");
  authContainer.classList.remove("hidden");
}

// expose
Object.assign(window,{
  signUp,logIn,logOut,openIframe,closeIframe,
  saveOnboarding,adminLogin,exitAdmin
});
</script>
</body>
</html>
